@using UORespawnApp.Scripts.Utilities
@inject ViewService ViewService
@inject IJSRuntime JS
@inject ToastService ToastService
@implements IDisposable

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid" style="display: flex; justify-content: center; align-items: center;">
        <a class="navbar-brand" href="" style="margin: 0;">
            <img src="logo.png" alt="UORespawn" style="height: 80px; width: auto; display: block;" />
        </a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" @onclick="ToggleMenu">
    <nav class="flex-column">
        <div class="nav-item px-3">
            <button class="nav-link btn btn-link @GetActiveClass("home")" @onclick="ShowHome">
                <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home
            </button>
        </div>
        <div class="nav-item px-3">
            <button class="nav-link btn btn-link @GetActiveClass("settings")" @onclick="ShowSettings">
                <span class="bi bi-gear-fill-nav-menu" aria-hidden="true"></span> Settings
            </button>
        </div>
        <div class="nav-item px-3">
            <button class="nav-link btn btn-link @GetActiveClass("instructions")" @onclick="ShowInstructions">
                <span class="bi bi-book-fill-nav-menu" aria-hidden="true"></span> Instructions
            </button>
        </div>
        <div class="nav-item px-3">
            <button class="nav-link btn btn-link @GetActiveClass("spawnpacks")" @onclick="ShowSpawnPacks">
                <span class="bi bi-boxes-nav-menu" aria-hidden="true"></span> Spawn Packs
            </button>
        </div>

        <div class="spawn-section">
            <!-- Active Pack Header -->
            <div class="active-pack-header">
                <span class="pack-name" title="@Settings.CurrentPackName">@Settings.CurrentPackName</span>
            </div>

            <div class="spawn-section-header px-3">
                <div class="map-selector-row">
                    <span class="bi bi-globe-americas-nav-menu map-icon" aria-hidden="true"></span>
                    <select class="form-select form-select-sm" 
                        @bind:get="ViewService.CurrentMapId" 
                        @bind:set="(int value) => ViewService.SetMap(value)">
                        @foreach (var mapId in GetAvailableMaps())
                        {
                            <option value="@mapId">@MapUtility.GetMapName(mapId)</option>
                        }
                    </select>
                </div>
            </div>

            <div class="nav-item px-3">
                <button class="nav-link btn btn-link @GetActiveClass("vendorspawn")" @onclick="ShowVendorSpawn">
                    <span class="bi bi-shop-nav-menu" aria-hidden="true"></span> Vendor Spawn
                </button>
            </div>
            <div class="nav-item px-3">
                <button class="nav-link btn btn-link @GetActiveClass("boxspawn")" @onclick="ShowBoxSpawn">
                    <span class="bi bi-map-fill-nav-menu" aria-hidden="true"></span> Box Spawn
                </button>
            </div>
            <div class="nav-item px-3">
                <button class="nav-link btn btn-link @GetActiveClass("regionspawn")" @onclick="ShowRegionSpawn">
                    <span class="bi bi-pin-map-fill-nav-menu" aria-hidden="true"></span> Region Spawn
                </button>
            </div>
            <div class="nav-item px-3">
                <button class="nav-link btn btn-link @GetActiveClass("tilespawn")" @onclick="ShowWorldSpawn">
                    <span class="bi bi-globe-nav-menu" aria-hidden="true"></span> Tile Spawn
                </button>
            </div>
            <div class="nav-item px-3">
                <button class="nav-link btn btn-link save-all-link" @onclick="SaveAll" title="Save All Data">
                    <span class="bi bi-save-nav-menu" aria-hidden="true"></span> Save All
                </button>
            </div>
        </div>

        <div class="nav-item px-3">
            <button class="nav-link btn btn-link theme-toggle" @onclick="ToggleTheme">
                <span class="bi @themeIcon" aria-hidden="true"></span> @themeText
            </button>
        </div>

        <!-- Update Checker at bottom of nav -->
        <UpdateNotification />
    </nav>
</div>

@code {
    private bool isDarkMode = true;
    private string themeIcon => isDarkMode ? "bi-sun-fill-nav-menu" : "bi-moon-fill-nav-menu";
    private string themeText => isDarkMode ? "Light Mode" : "Dark Mode";

    protected override void OnInitialized()
    {
        ViewService.OnActivePackChanged += OnPackChanged;
    }

    private void OnPackChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", "document.body.classList.add('dark-theme')");
        }
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        if (isDarkMode)
        {
            await JS.InvokeVoidAsync("eval", "document.body.classList.add('dark-theme'); document.body.classList.remove('light-theme');");
        }
        else
        {
            await JS.InvokeVoidAsync("eval", "document.body.classList.add('light-theme'); document.body.classList.remove('dark-theme');");
        }
    }

    private void ToggleMenu()
    {
    }

    private void ShowHome() => ViewService.SetView("home");
    private void ShowVendorSpawn() => ViewService.SetView("vendorspawn");
    private void ShowBoxSpawn() => ViewService.SetView("boxspawn");
    private void ShowRegionSpawn() => ViewService.SetView("regionspawn");
    private void ShowWorldSpawn() => ViewService.SetView("tilespawn");
    private void ShowSettings() => ViewService.SetView("settings");
    private void ShowInstructions() => ViewService.SetView("instructions");
    private void ShowSpawnPacks() => ViewService.SetView("spawnpacks");

    private string GetActiveClass(string view)
    {
        // Support both old and new route names
        if (view == "boxspawn" && ViewService.CurrentView == "mapview") return "active";
        if (view == "tilespawn" && ViewService.CurrentView == "worldspawn") return "active";
        return ViewService.CurrentView == view ? "active" : "";
    }

    private List<int> GetAvailableMaps()
    {
        // For now, return standard maps 0-5
        // Could be extended to use MapUtility.GetAvailableMaps() for dynamic discovery
        return new List<int> { 0, 1, 2, 3, 4, 5 };
    }

    private async Task SaveAll()
    {
        try
        {
            // Save all spawn data and settings
            Utility.SaveSettings();
            Utility.SaveSpawnData();
            Utility.SaveTileSpawnData();
            Utility.SaveRegionSpawnData();
            Utility.SaveVendorSpawnData();

            Logger.Info("Manual save completed - all data saved");
            ToastService.ShowSuccess("All data saved successfully!");
        }
        catch (Exception ex)
        {
            Logger.Error("Error during manual save", ex);
            ToastService.ShowWarning($"Error saving data: {ex.Message}");
        }

        await Task.CompletedTask;
    }

    public void Dispose()
    {
        ViewService.OnActivePackChanged -= OnPackChanged;
    }
}
