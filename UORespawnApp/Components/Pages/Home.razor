@page "/"

@using UORespawnApp.Scripts.Services
@inject ViewService ViewService
@inject WebViewService WebViewService

@implements IDisposable

<PageTitle>UORespawn Editor</PageTitle>

@if (ViewService.CurrentView == "home")
{
    <!-- Splash Screen (always visible, WebView overlays it via MAUI) -->
    <div style="position: fixed; top: 0; left: 250px; right: 0; bottom: 0; background-image: url('splash.png'); background-size: cover; background-position: center; background-repeat: no-repeat; z-index: 0;">
    </div>

    <!-- Open Website Button (always visible, WebView covers it when open) -->
    <button @onclick="OpenWebsite" 
            style="position: fixed; bottom: 16px; right: 32px; z-index: 10; background: transparent; border: none; cursor: pointer; padding: 0;"
            title="Black Box Programming">
        <span class="bi bi-box-fill" style="font-size: 50px; color: black;"></span>
    </button>
}
else if (ViewService.CurrentView == "boxspawn" || ViewService.CurrentView == "mapview") // Support both for backward compatibility
{
    <BoxSpawnComponent @key="ViewService.CurrentMapId.ToString()" />
}
else if (ViewService.CurrentView == "vendorspawn")
{
    <VendorSpawnComponent @key="ViewService.CurrentMapId.ToString()" />
}
else if (ViewService.CurrentView == "tilespawn" || ViewService.CurrentView == "worldspawn") // Support both old/new
{
    <TileSpawnComponent @key="ViewService.CurrentMapId.ToString()" />
}
else if (ViewService.CurrentView == "regionspawn")
{
    <RegionSpawnComponent @key="ViewService.CurrentMapId.ToString()" />
}
else if (ViewService.CurrentView == "settings")
{
    <SettingsComponent />
}
else if (ViewService.CurrentView == "instructions")
{
    <InstructionsComponent />
}
else if (ViewService.CurrentView == "spawnpacks")
{
    <SpawnPacksComponent />
}

@code {
    private const string WebsiteUrl = "http://blackboxprogramming.runasp.net";

    protected override void OnInitialized()
    {
        ViewService.OnViewChanged += OnViewChanged;
        ViewService.OnMapChanged += StateHasChanged;

        // MauiProgram already initialized session and loaded all data
        // Just log the component initialization
        try
        {
            var totalSpawns = Utility.BoxSpawns.Values.Sum(list => list.Count);
            Logger.Info($"Home component initialized - {totalSpawns} total spawn boxes loaded");
        }
        catch (Exception ex)
        {
            Logger.Error("Error in Home.OnInitialized", ex);
        }

        // Default to home view on startup
        if (string.IsNullOrEmpty(ViewService.CurrentView))
        {
            ViewService.SetView("home");
        }
    }

    private void OnViewChanged()
    {
        // Close WebView when navigating away from home
        if (ViewService.CurrentView != "home" && WebViewService.IsWebViewOpen)
        {
            WebViewService.HideWebView();
        }
        StateHasChanged();
    }

    private void OpenWebsite()
    {
        WebViewService.ShowWebView(WebsiteUrl);
        StateHasChanged();
    }

    public void Dispose()
    {
        ViewService.OnViewChanged -= OnViewChanged;
        ViewService.OnMapChanged -= StateHasChanged;

        // Ensure WebView is closed when disposing
        if (WebViewService.IsWebViewOpen)
        {
            WebViewService.HideWebView();
        }
    }
}
