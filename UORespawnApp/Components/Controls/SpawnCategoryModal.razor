@* Reusable modal for adding creatures to spawn categories (Common/Uncommon/Rare) *@

<div class="modal fade @(IsVisible ? "show d-block" : "")" tabindex="-1" style="@(IsVisible ? "background-color: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="badge @GetCategoryBadgeClass()">@CategoryName</span> @SpawnTypeName
                </h5>
                <button type="button" class="btn-close" @onclick="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="spawn-modal-layout">
                    <!-- Left: Bestiary Search/Select (Compact) -->
                    <div class="bestiary-panel">
                        <div class="panel-header">
                            <span class="bi bi-search me-2"></span>@SourceListName
                            @if (GetFavorites().Count > 0)
                            {
                                <span class="badge bg-warning text-dark ms-2" title="Favorites shown at top">
                                    <span class="bi bi-star-fill"></span> @GetFavorites().Count
                                </span>
                            }
                        </div>
                        <div class="search-box">
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   placeholder="Search..." 
                                   @bind="searchQuery" 
                                   @bind:event="oninput" />
                            @if (!string.IsNullOrEmpty(searchQuery))
                            {
                                <button class="clear-btn" @onclick="ClearSearch" title="Clear search">
                                    <span class="bi bi-x-lg"></span>
                                </button>
                            }
                        </div>
                        <div class="available-list">
                            @{
                                var filteredList = GetFilteredList();
                                var favorites = GetFavorites();
                                var favoritesInList = filteredList.Where(e => favorites.Contains(e)).ToList();
                                var nonFavorites = filteredList.Where(e => !favorites.Contains(e)).ToList();
                            }
                            @if (filteredList.Any())
                            {
                                @* Show favorites first *@
                                @if (favoritesInList.Any())
                                {
                                    @foreach (var entry in favoritesInList)
                                    {
                                        var count = CurrentSpawns.Count(s => s == entry);
                                        var hasAny = count > 0;
                                        <div class="available-item favorite-item @(hasAny ? "already-added" : "")" 
                                             @onclick="() => SelectEntry(entry)"
                                             title="Favorite - Click to add">
                                            <span class="bi bi-star-fill text-warning me-2" style="font-size: 0.8rem;"></span>
                                            <span class="entry-name">@entry</span>
                                            @if (hasAny)
                                            {
                                                <span class="badge bg-success me-1" style="font-size: 0.7rem;">@count</span>
                                            }
                                            <span class="bi bi-plus-circle add-icon"></span>
                                        </div>
                                    }
                                    @if (nonFavorites.Any())
                                    {
                                        <div class="favorites-divider">
                                            <span>All @SourceListName</span>
                                        </div>
                                    }
                                }
                                @* Then show non-favorites *@
                                @foreach (var entry in nonFavorites)
                                {
                                    var count = CurrentSpawns.Count(s => s == entry);
                                    var hasAny = count > 0;
                                    <div class="available-item @(hasAny ? "already-added" : "")" 
                                         @onclick="() => SelectEntry(entry)"
                                         title="Click to add another">
                                        <span class="entry-name">@entry</span>
                                        @if (hasAny)
                                        {
                                            <span class="badge bg-success me-1" style="font-size: 0.7rem;">@count</span>
                                        }
                                        <span class="bi bi-plus-circle add-icon"></span>
                                    </div>
                                }
                            }
                            else if (!string.IsNullOrEmpty(searchQuery))
                            {
                                <div class="empty-state">
                                    <span class="bi bi-emoji-frown"></span>
                                    <span>No matches for "@searchQuery"</span>
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <span class="bi bi-search"></span>
                                    <span>Type to search...</span>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Right: Selected Spawns (Primary Focus) -->
                    <div class="selected-panel">
                        <div class="panel-header">
                            <span>
                                <span class="bi bi-list-check me-2"></span>Selected
                                <span class="badge bg-light text-dark ms-2">@CurrentSpawns.Count</span>
                            </span>
                            @if (CurrentSpawns.Count > 0)
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="ClearAll" title="Clear all">
                                    <span class="bi bi-trash"></span>
                                </button>
                            }
                        </div>
                        <div class="selected-list">
                            @if (CurrentSpawns.Count > 0)
                            {
                                @foreach (var spawn in CurrentSpawns)
                                {
                                    <div class="selected-item">
                                        <span class="spawn-name">@spawn</span>
                                        <button class="btn btn-sm btn-outline-danger remove-btn" 
                                                @onclick="() => RemoveEntry(spawn)" 
                                                title="Remove">
                                            <span class="bi bi-x-lg"></span>
                                        </button>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="empty-selected">
                                    <span class="bi bi-inbox" style="font-size: 2rem; opacity: 0.3;"></span>
                                    <p>No spawns selected</p>
                                    <small>Search and click creatures on the left to add them</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="SaveAndClose">
                    <span class="bi bi-check-lg"></span> Save (@CurrentSpawns.Count)
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string CategoryName { get; set; } = "Common";
    [Parameter] public string SpawnTypeName { get; set; } = "Spawns";
    [Parameter] public string SourceListName { get; set; } = "Bestiary";
    [Parameter] public List<string> CurrentSpawns { get; set; } = new();
    [Parameter] public List<string> SourceList { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }

    private string searchQuery = "";

    /// <summary>
    /// Gets the appropriate favorites list based on SourceListName,
    /// filtered to only include items that exist in the current SourceList
    /// </summary>
    private List<string> GetFavorites()
    {
        var allFavorites = SourceListName.ToLower() switch
        {
            "vendors" or "vendor list" => Settings.VendorFavorites,
            _ => Settings.BestiaryFavorites
        };

        // Only return favorites that exist in the current source list
        if (SourceList == null || SourceList.Count == 0)
            return [];

        return allFavorites.Where(f => SourceList.Contains(f)).ToList();
    }

    private List<string> GetFilteredList()
    {
        if (SourceList == null || SourceList.Count == 0)
        {
            return [];
        }

        if (string.IsNullOrEmpty(searchQuery))
        {
            return SourceList;
        }

        // Case-insensitive search - EXACTLY like Settings page
        return SourceList
            .Where(s => s.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private string GetCategoryBadgeClass()
    {
        return CategoryName.ToLower() switch
        {
            "water" => "bg-primary",        // Blue for water
            "weather" => "bg-secondary",    // Gray for weather
            "timed" => "bg-info",           // Light blue/purple for timed
            "common" => "bg-success",       // Green for common
            "uncommon" => "bg-warning",     // Yellow/orange for uncommon
            "rare" => "bg-danger",          // Red for rare
            _ => "bg-secondary"
        };
    }

    private void ClearSearch()
    {
        searchQuery = "";
        StateHasChanged();
    }

    private void SelectEntry(string entry)
    {
        // Allow duplicates - e.g., 3 Beekeepers at one hive
        CurrentSpawns.Add(entry);
        Logger.Info($"Added {entry} to {CategoryName} {SpawnTypeName}");
        StateHasChanged();
    }

    private void RemoveEntry(string entry)
    {
        CurrentSpawns.Remove(entry);
        Logger.Info($"Removed {entry} from {CategoryName} {SpawnTypeName}");
        StateHasChanged();
    }

    private void ClearAll()
    {
        CurrentSpawns.Clear();
        Logger.Info($"Cleared all {CategoryName} {SpawnTypeName}");
        StateHasChanged();
    }

    private async Task Close()
    {
        IsVisible = false;
        searchQuery = "";
        await OnClose.InvokeAsync();
    }

    private async Task SaveAndClose()
    {
        await OnSave.InvokeAsync();
        await Close();
    }
}

