@using Microsoft.JSInterop
@using Microsoft.Maui.Graphics
@using System.Text.Json
@using UORespawnApp.Scripts.Utilities
@using UORespawnApp.Scripts.Entities
@using UORespawnApp.Scripts.DTO.Enums
@using UORespawnApp.Scripts.Services
@inject IJSRuntime JS
@inject ViewService ViewService
@inject ToastService ToastService
@implements IDisposable

<div class="container-fluid p-3">
    <div class="row">
        <div class="col-lg-9">
            <div class="alert alert-dark mb-2 d-flex justify-content-between align-items-center" style="width:800px;">
                <div>
                    <strong>@MapUtility.GetMapName(ViewService.CurrentMapId)</strong> | Size: @imageDim | Mouse: (@mouseWorldX, @mouseWorldY)
                </div>
                <button class="btn btn-sm @(zoomLevel == 2.0 ? "btn-primary" : "btn-outline-primary")" @onclick="ToggleZoom" title="Toggle Zoom (1x / 2x)">
                    <span class="bi bi-zoom-@(zoomLevel == 2.0 ? "in" : "out")"></span> @(zoomLevel == 1.0 ? "1x" : "2x")
                </button>
            </div>
            <div style="position:relative; overflow:hidden; width:800px; height:600px; background:#1a1a1a; border:1px solid #333;" 
                 tabindex="0" 
                 @onkeydown="OnKeyDown"
                 @onkeyup="OnKeyUp"
                 @onmouseenter="OnMapMouseEnter"
                 @ref="mapContainerRef">
                <img id="regionMapImg" src="@imageSrc" 
                     style="position:absolute; left:0; top:0; image-rendering:pixelated; transform-origin: top left; transform: scale(@(zoomLevel.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)));"
                     @onload="OnImageLoaded" />
                <canvas id="regionMapCanvas" width="800" height="600"
                        style="position:absolute; top:0; left:0; cursor:pointer;"
                        @onmousedown="OnMouseDown"
                        @onmousemove="OnMouseMove"
                        @onmouseup="OnMouseUp"
                        @onmouseleave="OnMouseLeave"
                        @oncontextmenu:preventDefault />
            </div>
            <div class="card mt-2 shadow-sm" style="width:800px;">
                <div class="card-body py-2">
                    <small class="text-muted">
                        <strong>Controls:</strong> Left-Click Region = Select | Right-Drag = Pan Map | Arrow Keys/WASD = Pan Map
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 right-column-container" style="padding-left:15px;">
            <!-- Mini Map - Collapsible -->
            <div class="card shadow-sm mb-3 map-card">
                <div class="card-header text-center d-flex justify-content-between align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ResetView" title="Reset View & Zoom" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <span class="bi bi-arrow-counterclockwise"></span>
                    </button>
                    <strong>Mini Map</strong>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleMiniMap" title="@(showMiniMap ? "Collapse Mini Map" : "Expand Mini Map")" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <span class="bi @(showMiniMap ? "bi-list" : "bi-chevron-down")"></span>
                    </button>
                </div>
                @if (showMiniMap)
                {
                    <div class="card-body p-2 minimap-body" @key="@("minimap-body")">
                        <canvas id="regionMiniMapCanvas" width="250" height="188"
                                style="cursor:pointer; border:1px solid #333; display:block; image-rendering:pixelated; width: 100%; height: auto;"
                                @onclick="OnMiniMapClick" />
                    </div>
                }
            </div>
            
            <!-- Region Spawn List - Flex to fill remaining space -->
            <div class="card shadow-sm map-card spawn-list-container">
                <div class="card-header text-center spawn-list-header">
                    <strong>Regions</strong>
                    <strong>@GetRegionCount()</strong>
                </div>
                <div class="card-body p-2 spawn-list-body">
                    @{
                        var regions = GetRegionsForCurrentMap();
                    }
                    @if (regions.Any())
                    {
                        @foreach (var region in regions.OrderBy(r => r.Name))
                        {
                            var entity = GetRegionEntity(region.Name);
                            var isSelected = selectedRegion != null && selectedRegion.Name == region.Name;
                            
                            <div class="spawn-item @(isSelected ? "selected" : "")" @onclick="() => SelectRegion(region)">
                                <div class="d-flex align-items-center justify-content-between">
                                    <strong>@region.Name</strong>
                                    @if (entity != null && entity.GetTotalSpawnCount() > 0)
                                    {
                                        <span class="badge bg-warning text-dark">@entity.GetTotalSpawnCount()</span>
                                    }
                                </div>
                                
                                @if (isSelected && entity != null)
                                {
                                    <div class="spawn-controls">
                                        <!-- 6 Frequency Buttons in 2x3 Grid -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-4">
                                                <button class="btn btn-sm btn-primary w-100" style="aspect-ratio: 1; border: 2px solid; padding: 0;" 
                                                        title="Water Spawns (Chance: @Settings.ChanceWater%)"
                                                        @onclick="() => OpenCategoryModal(entity, Frequency.Water)">
                                                    <span style="font-size: 2.2em;">üíß</span>
                                                    <div style="font-size: 0.75rem; font-weight: bold;">@entity.WaterSpawns.Count</div>
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-sm btn-info w-100" style="aspect-ratio: 1; border: 2px solid; padding: 0;" 
                                                        title="Weather Spawns (Chance: @Settings.ChanceWeather%)"
                                                        @onclick="() => OpenCategoryModal(entity, Frequency.Weather)">
                                                    <span style="font-size: 2.2em;">‚õàÔ∏è</span>
                                                    <div style="font-size: 0.75rem; font-weight: bold;">@entity.WeatherSpawns.Count</div>
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-sm btn-dark w-100" style="aspect-ratio: 1; border: 2px solid; padding: 0;" 
                                                        title="Timed Spawns (Chance: @Settings.ChanceTimed%)"
                                                        @onclick="() => OpenCategoryModal(entity, Frequency.Timed)">
                                                    <span style="font-size: 2.2em;">üïê</span>
                                                    <div style="font-size: 0.75rem; font-weight: bold;">@entity.TimedSpawns.Count</div>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-3">
                                            <div class="col-4">
                                                <button class="btn btn-sm btn-success w-100" style="aspect-ratio: 1; border: 2px solid; padding: 0;" 
                                                        title="Common Spawns (Chance: @Settings.ChanceCommon%)"
                                                        @onclick="() => OpenCategoryModal(entity, Frequency.Common)">
                                                    <span style="font-size: 2.2em;">üë•</span>
                                                    <div style="font-size: 0.75rem; font-weight: bold;">@entity.CommonSpawns.Count</div>
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-sm btn-warning w-100" style="aspect-ratio: 1; border: 2px solid; padding: 0;" 
                                                        title="Uncommon Spawns (Chance: @Settings.ChanceUncommon%)"
                                                        @onclick="() => OpenCategoryModal(entity, Frequency.UnCommon)">
                                                    <span style="font-size: 2.2em;">üë§</span>
                                                    <div style="font-size: 0.75rem; font-weight: bold;">@entity.UncommonSpawns.Count</div>
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-sm btn-danger w-100" style="aspect-ratio: 1; border: 2px solid; padding: 0;" 
                                                        title="Rare Spawns (Chance: @Settings.ChanceRare%)"
                                                        @onclick="() => OpenCategoryModal(entity, Frequency.Rare)">
                                                    <span style="font-size: 2.2em;">‚≠ê</span>
                                                    <div style="font-size: 0.75rem; font-weight: bold;">@entity.RareSpawns.Count</div>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Trigger Dropdowns -->
                                        <div class="row g-2 mt-2">
                                            <div class="col-6">
                                                <label class="form-label mb-0" style="font-size: 0.75rem;">Weather Trigger</label>
                                                <select class="form-select form-select-sm" 
                                                        @bind="entity.WeatherSpawn" 
                                                        @bind:after="() => SaveCurrentRegion(entity)"
                                                        disabled="@(entity.WeatherSpawns.Count == 0)">
                                                    <option value="@WeatherTypes.None">None</option>
                                                    <option value="@WeatherTypes.Rain">Rain</option>
                                                    <option value="@WeatherTypes.Snow">Snow</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label mb-0" style="font-size: 0.75rem;">Timed Trigger</label>
                                                <select class="form-select form-select-sm" 
                                                        @bind="entity.TimedSpawn" 
                                                        @bind:after="() => SaveCurrentRegion(entity)"
                                                        disabled="@(entity.TimedSpawns.Count == 0)">
                                                    <option value="@TimeNames.None">None</option>
                                                    <option value="@TimeNames.Witching_Hour">Witching Hour</option>
                                                    <option value="@TimeNames.Middle_of_Night">Middle of Night</option>
                                                    <option value="@TimeNames.Early_Morning">Early Morning</option>
                                                    <option value="@TimeNames.Late_Morning">Late Morning</option>
                                                    <option value="@TimeNames.Noon">Noon</option>
                                                    <option value="@TimeNames.Afternoon">Afternoon</option>
                                                    <option value="@TimeNames.Early_Evening">Early Evening</option>
                                                    <option value="@TimeNames.Late_at_Night">Late at Night</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <small>No regions loaded for this map</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (showModal && currentEntity != null)
{
    <SpawnCategoryModal IsVisible="@showModal"
                        CategoryName="@GetFrequencyName()"
                        SpawnTypeName="Spawns"
                        SourceListName="Bestiary"
                        CurrentSpawns="@currentCategorySpawns"
                        SourceList="@(WorldSpawnUtility.SpawnList ?? new List<string>())"
                        OnClose="@CloseModal"
                        OnSave="@SaveModal" />
}

@code {
    // Map rendering fields
    private ElementReference mapContainerRef;
    private string imageSrc = "";
    private string imageDim = "";
    private int imageWidth;
    private int imageHeight;
    private double zoomLevel = 1.0;
    private double offsetX = 0.0;
    private double offsetY = 0.0;
    private int mouseWorldX = 0;
    private int mouseWorldY = 0;
    private bool showMiniMap = true;

    // Map panning
    private bool isPanning = false;
    private int panStartMouseX = 0;
    private int panStartMouseY = 0;
    private double panStartOffsetX = 0.0;
    private double panStartOffsetY = 0.0;
    private HashSet<string> pressedKeys = new();
    private System.Timers.Timer? keyPanTimer;

    // Region selection
    private RegionInfo? selectedRegion = null;
    private RegionInfo? hoveredRegion = null;

    // Modal state
    private bool showModal = false;
    private RegionSpawnEntity? currentEntity = null;
    private List<string> currentCategorySpawns = new();
    private Frequency currentFrequency = Frequency.Common;

    protected override async Task OnInitializedAsync()
    {
        ViewService.OnViewChanged += OnViewChanged;
        LoadMapImage();

        // Initialize key pan timer (for smooth keyboard panning)
        keyPanTimer = new System.Timers.Timer(16); // ~60 FPS
        keyPanTimer.Elapsed += (s, e) => InvokeAsync(HandleKeyPan);
    }

    private void OnViewChanged()
    {
        ResetView();
        LoadMapImage();
        selectedRegion = null;
        InvokeAsync(StateHasChanged);
    }

    private void LoadMapImage()
    {
        var mapId = ViewService.CurrentMapId;
        imageSrc = $"Resources/Maps/Map{mapId}.bmp";

        // Use standard UO map dimensions (most maps are 7168x4096)
        // Map 0-1: 7168x4096, Map 2-5: 2304x1600
        (imageWidth, imageHeight) = mapId switch
        {
            0 or 1 => (7168, 4096),
            2 or 3 or 4 or 5 => (2304, 1600),
            _ => (7168, 4096) // Default for custom maps
        };
        imageDim = $"{imageWidth} x {imageHeight}";

        Logger.Info($"Region Spawn loaded map {mapId}: {imageDim}");
    }

    private async Task OnImageLoaded()
    {
        await Task.Delay(100); // Give the browser time to render
        await RenderRegions();
        await RenderMiniMap();
    }

    // ===================== MAP CONTROLS =====================

    private void ToggleZoom()
    {
        zoomLevel = zoomLevel == 1.0 ? 2.0 : 1.0;
        StateHasChanged();
    }

    private void ResetView()
    {
        offsetX = 0.0;
        offsetY = 0.0;
        zoomLevel = 1.0;
        StateHasChanged();
        InvokeAsync(async () =>
        {
            await RenderRegions();
            await RenderMiniMap();
        });
    }

    private void ToggleMiniMap()
    {
        showMiniMap = !showMiniMap;
        StateHasChanged();
        if (showMiniMap)
        {
            InvokeAsync(RenderMiniMap);
        }
    }

    // ===================== MOUSE EVENTS =====================

    private async Task OnMouseDown(MouseEventArgs e)
    {
        if (e.Button == 2) // Right-click for panning
        {
            isPanning = true;
            panStartMouseX = (int)e.OffsetX;
            panStartMouseY = (int)e.OffsetY;
            panStartOffsetX = offsetX;
            panStartOffsetY = offsetY;
        }
        else if (e.Button == 0) // Left-click for region selection
        {
            var worldX = ScreenToWorldX(e.OffsetX);
            var worldY = ScreenToWorldY(e.OffsetY);
            
            var clickedRegion = RegionDataUtility.FindRegionAt(ViewService.CurrentMapId, worldX, worldY);
            if (clickedRegion != null)
            {
                SelectRegion(clickedRegion);
                await RenderRegions();
            }
        }
    }

    private async Task OnMouseMove(MouseEventArgs e)
    {
        // Update mouse world coordinates
        mouseWorldX = ScreenToWorldX(e.OffsetX);
        mouseWorldY = ScreenToWorldY(e.OffsetY);
        
        if (isPanning)
        {
            var deltaX = (int)e.OffsetX - panStartMouseX;
            var deltaY = (int)e.OffsetY - panStartMouseY;
            offsetX = panStartOffsetX + deltaX;
            offsetY = panStartOffsetY + deltaY;
            await RenderRegions();
            StateHasChanged();
        }
        else
        {
            // Check for region hover
            var region = RegionDataUtility.FindRegionAt(ViewService.CurrentMapId, mouseWorldX, mouseWorldY);
            if (region != hoveredRegion)
            {
                hoveredRegion = region;
                await RenderRegions();
            }
        }
    }

    private void OnMouseUp(MouseEventArgs e)
    {
        if (e.Button == 2)
        {
            isPanning = false;
        }
    }

    private void OnMouseLeave(MouseEventArgs e)
    {
        isPanning = false;
        hoveredRegion = null;
        InvokeAsync(RenderRegions);
    }

    private async Task OnMiniMapClick(MouseEventArgs e)
    {
        var canvas = await JS.InvokeAsync<JsonElement>("document.getElementById", "regionMiniMapCanvas");
        var rect = await JS.InvokeAsync<JsonElement>("getElementBoundingRect", "regionMiniMapCanvas");
        
        double canvasWidth = rect.GetProperty("width").GetDouble();
        double canvasHeight = rect.GetProperty("height").GetDouble();
        
        double clickX = e.OffsetX;
        double clickY = e.OffsetY;
        
        // Convert mini map click to world coordinates
        double worldX = (clickX / canvasWidth) * imageWidth;
        double worldY = (clickY / canvasHeight) * imageHeight;
        
        // Center the main view on this point
        offsetX = -(worldX * zoomLevel) + 400; // 400 = half of 800px canvas width
        offsetY = -(worldY * zoomLevel) + 300; // 300 = half of 600px canvas height
        
        await RenderRegions();
        await RenderMiniMap();
        StateHasChanged();
    }

    // ===================== KEYBOARD PANNING =====================

    private void OnMapMouseEnter(MouseEventArgs e)
    {
        mapContainerRef.FocusAsync();
    }

    private void OnKeyDown(KeyboardEventArgs e)
    {
        var key = e.Key.ToLower();
        if (IsMovementKey(key))
        {
            pressedKeys.Add(key);
            if (keyPanTimer != null && !keyPanTimer.Enabled)
            {
                keyPanTimer.Start();
            }
        }
    }

    private void OnKeyUp(KeyboardEventArgs e)
    {
        var key = e.Key.ToLower();
        pressedKeys.Remove(key);
        if (pressedKeys.Count == 0 && keyPanTimer != null)
        {
            keyPanTimer.Stop();
        }
    }

    private bool IsMovementKey(string key)
    {
        return key is "arrowup" or "arrowdown" or "arrowleft" or "arrowright" or 
                      "w" or "s" or "a" or "d";
    }

    private void HandleKeyPan()
    {
        if (pressedKeys.Count == 0) return;
        
        const double panSpeed = 10.0;
        bool moved = false;
        
        if (pressedKeys.Contains("arrowleft") || pressedKeys.Contains("a"))
        {
            offsetX += panSpeed;
            moved = true;
        }
        if (pressedKeys.Contains("arrowright") || pressedKeys.Contains("d"))
        {
            offsetX -= panSpeed;
            moved = true;
        }
        if (pressedKeys.Contains("arrowup") || pressedKeys.Contains("w"))
        {
            offsetY += panSpeed;
            moved = true;
        }
        if (pressedKeys.Contains("arrowdown") || pressedKeys.Contains("s"))
        {
            offsetY -= panSpeed;
            moved = true;
        }
        
        if (moved)
        {
            InvokeAsync(async () =>
            {
                await RenderRegions();
                StateHasChanged();
            });
        }
    }

    // ===================== COORDINATE CONVERSION =====================

    private int ScreenToWorldX(double screenX)
    {
        return (int)((screenX - offsetX) / zoomLevel);
    }

    private int ScreenToWorldY(double screenY)
    {
        return (int)((screenY - offsetY) / zoomLevel);
    }

    private double WorldToScreenX(int worldX)
    {
        return worldX * zoomLevel + offsetX;
    }

    private double WorldToScreenY(int worldY)
    {
        return worldY * zoomLevel + offsetY;
    }

    // ===================== REGION RENDERING =====================

    private async Task RenderRegions()
    {
        try
        {
            var regions = GetRegionsForCurrentMap();
            if (regions.Count == 0) return;
            
            // Convert regions to screen coordinates
            var screenRegions = regions.Select(r => new
            {
                name = r.Name,
                rectangles = r.Rectangles.Select(rect => new
                {
                    x = WorldToScreenX((int)rect.X),
                    y = WorldToScreenY((int)rect.Y),
                    width = rect.Width * zoomLevel,
                    height = rect.Height * zoomLevel
                }).ToList()
            }).ToList();
            
            var selectedName = selectedRegion?.Name ?? "";
            var hoveredName = hoveredRegion?.Name ?? "";
            
            await JS.InvokeVoidAsync("drawRegions", "regionMapCanvas", screenRegions, selectedName, hoveredName);
        }
        catch (Exception ex)
        {
            Logger.Error("Error rendering regions", ex);
        }
    }

    private async Task RenderMiniMap()
    {
        if (!showMiniMap) return;
        
        try
        {
            // Calculate viewport rectangle in world coordinates
            var viewX = -offsetX / zoomLevel;
            var viewY = -offsetY / zoomLevel;
            var viewWidth = 800.0 / zoomLevel;
            var viewHeight = 600.0 / zoomLevel;
            
            // Get all spawns for mini map (regions with spawn counts)
            var spawnData = Utility.RegionSpawns.TryGetValue(ViewService.CurrentMapId, out var list) 
                ? list.Where(r => r.GetTotalSpawnCount() > 0).Select(r => (object)new
                {
                    x = r.RegionBounds.FirstOrDefault().X,
                    y = r.RegionBounds.FirstOrDefault().Y,
                    count = r.GetTotalSpawnCount()
                }).ToList()
                : new List<object>();
            
            await JS.InvokeVoidAsync("drawMiniMap", 
                "regionMiniMapCanvas", 
                imageWidth, 
                imageHeight, 
                viewX, 
                viewY, 
                viewWidth, 
                viewHeight,
                spawnData,
                new List<object>(), // No XML spawners for regions
                false, // showXML
                true); // showSpawns
        }
        catch (Exception ex)
        {
            Logger.Error("Error rendering mini map", ex);
        }
    }

    // ===================== REGION DATA =====================

    private List<RegionInfo> GetRegionsForCurrentMap()
    {
        return RegionDataUtility.GetRegionsForMap(ViewService.CurrentMapId);
    }

    private int GetRegionCount()
    {
        return GetRegionsForCurrentMap().Count;
    }

    private RegionSpawnEntity? GetRegionEntity(string regionName)
    {
        if (!Utility.RegionSpawns.TryGetValue(ViewService.CurrentMapId, out var list))
            return null;
        
        return list.FirstOrDefault(r => r.Name.Equals(regionName, StringComparison.OrdinalIgnoreCase));
    }

    private void SelectRegion(RegionInfo region)
    {
        selectedRegion = region;
        
        // Get or create entity
        if (!Utility.RegionSpawns.TryGetValue(ViewService.CurrentMapId, out var list))
        {
            list = new List<RegionSpawnEntity>();
            Utility.RegionSpawns[ViewService.CurrentMapId] = list;
        }
        
        var existing = list.FirstOrDefault(r => r.Name.Equals(region.Name, StringComparison.OrdinalIgnoreCase));
        if (existing != null)
        {
            currentEntity = existing;
        }
        else
        {
            // Create new entity with next available ID
            var nextId = list.Count > 0 ? list.Max(x => x.Id) + 1 : 1;
            currentEntity = new RegionSpawnEntity
            {
                Id = nextId,
                Name = region.Name,
                MapId = ViewService.CurrentMapId,
                RegionBounds = region.Rectangles.ToList()
            };
            list.Add(currentEntity);
        }
        
        StateHasChanged();
    }

    // ===================== MODAL HANDLING =====================

    private void OpenCategoryModal(RegionSpawnEntity entity, Frequency frequency)
    {
        currentEntity = entity;
        currentFrequency = frequency;

        currentCategorySpawns = frequency switch
        {
            Frequency.Water => new List<string>(entity.WaterSpawns),
            Frequency.Weather => new List<string>(entity.WeatherSpawns),
            Frequency.Timed => new List<string>(entity.TimedSpawns),
            Frequency.Common => new List<string>(entity.CommonSpawns),
            Frequency.UnCommon => new List<string>(entity.UncommonSpawns),
            Frequency.Rare => new List<string>(entity.RareSpawns),
            _ => new List<string>()
        };

        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        StateHasChanged();
    }

    private void SaveModal()
    {
        if (currentEntity == null) return;

        // The modal updates CurrentSpawns directly, so we just need to copy it back
        var updatedList = new List<string>(currentCategorySpawns);

        // Update the appropriate list
        switch (currentFrequency)
        {
            case Frequency.Water:
                currentEntity.WaterSpawns = updatedList;
                break;
            case Frequency.Weather:
                currentEntity.WeatherSpawns = updatedList;
                // Auto-set trigger if spawns added and trigger is None
                if (updatedList.Count > 0 && currentEntity.WeatherSpawn == WeatherTypes.None)
                {
                    currentEntity.WeatherSpawn = WeatherTypes.Rain;
                }
                // Auto-reset trigger if all spawns removed
                if (updatedList.Count == 0)
                {
                    currentEntity.WeatherSpawn = WeatherTypes.None;
                }
                break;
            case Frequency.Timed:
                currentEntity.TimedSpawns = updatedList;
                // Auto-set trigger if spawns added and trigger is None
                if (updatedList.Count > 0 && currentEntity.TimedSpawn == TimeNames.None)
                {
                    currentEntity.TimedSpawn = TimeNames.Witching_Hour;
                }
                // Auto-reset trigger if all spawns removed
                if (updatedList.Count == 0)
                {
                    currentEntity.TimedSpawn = TimeNames.None;
                }
                break;
            case Frequency.Common:
                currentEntity.CommonSpawns = updatedList;
                break;
            case Frequency.UnCommon:
                currentEntity.UncommonSpawns = updatedList;
                break;
            case Frequency.Rare:
                currentEntity.RareSpawns = updatedList;
                break;
        }

        SaveCurrentRegion(currentEntity);
        CloseModal();
        StateHasChanged();
    }

    private void SaveCurrentRegion(RegionSpawnEntity entity)
    {
        try
        {
            Utility.SaveRegionSpawnData();
            Logger.Info($"Auto-saved region spawn data for {entity.Name}");
        }
        catch (Exception ex)
        {
            Logger.Error("Failed to save region spawn data", ex);
            ToastService.ShowError("Failed to save region spawn data");
        }
    }

    private string GetFrequencyName()
    {
        return currentFrequency switch
        {
            Frequency.Water => "üíß Water",
            Frequency.Weather => "‚õàÔ∏è Weather",
            Frequency.Timed => "üïê Timed",
            Frequency.Common => "üë• Common",
            Frequency.UnCommon => "üë§ Uncommon",
            Frequency.Rare => "‚≠ê Rare",
            _ => "Spawns"
        };
    }

    public void Dispose()
    {
        ViewService.OnViewChanged -= OnViewChanged;
        keyPanTimer?.Dispose();
    }
}
