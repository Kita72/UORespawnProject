@using UORespawnApp.Scripts.Entities

<div class="card spawn-pack-card shadow-sm" @onclick="HandleSelect">
    <div class="spawn-pack-header">
        @Pack.Metadata.Name
    </div>
    <div class="spawn-pack-image">
        <img src="@GetImageSource()" alt="@Pack.Metadata.Name" />
    </div>
    <div class="card-body spawn-pack-details">
        <div class="spawn-pack-author">By: @Pack.Metadata.Author</div>
        <div class="spawn-pack-actions">
            <button class="btn btn-sm btn-link" type="button" title="Like" @onclick:stopPropagation="true" @onclick="ToggleLike">
                <span class="bi @(Pack.IsLiked ? "bi-heart-fill" : "bi-heart")"></span>
            </button>
            <button class="btn btn-sm btn-link" type="button" title="Favorite" @onclick:stopPropagation="true" @onclick="ToggleFavorite">
                <span class="bi @(Pack.IsFavorite ? "bi-star-fill" : "bi-star")"></span>
            </button>
            <button class="btn btn-sm btn-link" 
                    type="button" 
                    title="Apply"
                    @onclick:stopPropagation="true" 
                    @onclick="ApplyPack">
                <span class="bi bi-check2-circle"></span>
            </button>
            <button class="btn btn-sm btn-link info-btn" 
                    type="button" 
                    title="@GetInfoTooltip()"
                    @onclick:stopPropagation="true" 
                    @onclick="ShowInfo">
                <span class="bi bi-info-circle"></span>
            </button>
            @if (ShowDelete && !Pack.Metadata.IsApproved)
            {
                <button class="btn btn-sm btn-link delete-btn" 
                        type="button" 
                        title="Delete pack" 
                        @onclick:stopPropagation="true" 
                        @onclick="DeletePack">
                    <span class="bi bi-trash"></span>
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public SpawnPackInfo Pack { get; set; } = new();

    [Parameter]
    public EventCallback<SpawnPackInfo> OnSelect { get; set; }

    [Parameter]
    public EventCallback<SpawnPackInfo> OnLike { get; set; }

    [Parameter]
    public EventCallback<SpawnPackInfo> OnFavorite { get; set; }

    [Parameter]
    public EventCallback<SpawnPackInfo> OnApply { get; set; }

    [Parameter]
    public EventCallback<SpawnPackInfo> OnDelete { get; set; }

    [Parameter]
    public EventCallback<SpawnPackInfo> OnInfo { get; set; }

    [Parameter]
    public bool ShowDelete { get; set; } = false;

    private async Task HandleSelect()
    {
        if (OnSelect.HasDelegate)
        {
            await OnSelect.InvokeAsync(Pack);
        }
    }

    private async Task ToggleLike()
    {
        Pack.IsLiked = !Pack.IsLiked;
        if (OnLike.HasDelegate)
        {
            await OnLike.InvokeAsync(Pack);
        }
    }

    private async Task ToggleFavorite()
    {
        Pack.IsFavorite = !Pack.IsFavorite;
        if (OnFavorite.HasDelegate)
        {
            await OnFavorite.InvokeAsync(Pack);
        }
    }

    private async Task ApplyPack()
    {
        if (OnApply.HasDelegate)
        {
            await OnApply.InvokeAsync(Pack);
        }
    }

    private async Task ShowInfo()
    {
        if (OnInfo.HasDelegate)
        {
            await OnInfo.InvokeAsync(Pack);
        }
    }

    private async Task DeletePack()
    {
        // Safety: never delete approved packs
        if (Pack.Metadata.IsApproved)
        {
            return;
        }

        if (OnDelete.HasDelegate)
        {
            await OnDelete.InvokeAsync(Pack);
        }
    }

    private string GetImageSource()
    {
        // If image path is set and it's a file path, convert to base64
        if (!string.IsNullOrWhiteSpace(Pack.Metadata.ImageFileName))
        {
            if (File.Exists(Pack.Metadata.ImageFileName))
            {
                try
                {
                    var bytes = File.ReadAllBytes(Pack.Metadata.ImageFileName);
                    var ext = Path.GetExtension(Pack.Metadata.ImageFileName).ToLowerInvariant();
                    var mimeType = ext switch
                    {
                        ".png" => "image/png",
                        ".jpg" or ".jpeg" => "image/jpeg",
                        ".gif" => "image/gif",
                        ".webp" => "image/webp",
                        _ => "image/png"
                    };
                    return $"data:{mimeType};base64,{Convert.ToBase64String(bytes)}";
                }
                catch
                {
                    // Fall through to default
                }
            }
        }

        // Default to app logo
        return "logo.png";
    }

    private string GetInfoTooltip()
    {
        // Default Spawn Pack gets special modal - show minimal tooltip
        if (Pack.Metadata.Name == "Default Spawn Pack")
        {
            return "View Ecology Info";
        }

        // For other packs, show description if available
        if (!string.IsNullOrWhiteSpace(Pack.Metadata.Description))
        {
            return Pack.Metadata.Description;
        }

        return "Pack Info";
    }
}
