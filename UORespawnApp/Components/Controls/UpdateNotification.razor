@using UORespawnApp.Scripts.Services
@inject UpdateChecker UpdateChecker
@inject NavigationManager Navigation
@implements IDisposable

<div class="update-section">
    @if (isChecking)
    {
        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
            <div class="d-flex align-items-center justify-content-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Checking...</span>
                </div>
                <span>Checking...</span>
            </div>
        </button>
    }
    else if (updateInfo?.HasUpdate == true)
    {
        <button class="btn btn-warning btn-sm w-100 update-available" @onclick="OpenReleases">
            <span class="bi bi-arrow-up-circle-fill me-1"></span>
            Update: v@(updateInfo.LatestVersion)
            <span class="current-version">(current: v@(UpdateChecker.CurrentVersion))</span>
        </button>
    }
    else if (!string.IsNullOrEmpty(updateInfo?.ErrorMessage))
    {
        <button class="btn btn-outline-secondary btn-sm w-100" @onclick="CheckForUpdates">
            <span class="bi bi-exclamation-triangle me-1"></span>
            v@(UpdateChecker.CurrentVersion)
            <span class="bi bi-arrow-clockwise ms-2" title="Retry check"></span>
        </button>
    }
    else
    {
        <button class="btn btn-success btn-sm w-100" @onclick="OpenReleases" title="Click for releases, or use refresh to check">
            <span class="bi bi-check-circle-fill me-1"></span>
            v@(UpdateChecker.CurrentVersion)
            <span class="bi bi-arrow-clockwise ms-2 refresh-icon" @onclick:stopPropagation="true" @onclick="CheckForUpdates" title="Check for updates"></span>
        </button>
    }
</div>

@code {
    private UpdateInfo? updateInfo;
    private bool isChecking = false;
    private System.Threading.Timer? _autoCheckTimer;
    
    protected override async Task OnInitializedAsync()
    {
        // Check for updates on startup (after 3 second delay to not interfere with initial load)
        await Task.Delay(3000);
        await CheckForUpdates();
        
        // Set up auto-check every 6 hours
        _autoCheckTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () => await CheckForUpdates());
        }, null, TimeSpan.FromHours(6), TimeSpan.FromHours(6));
    }
    
    private async Task CheckForUpdates()
    {
        if (isChecking) return;
        
        isChecking = true;
        StateHasChanged();
        
        try
        {
            updateInfo = await UpdateChecker.CheckForUpdateAsync();
        }
        catch (Exception ex)
        {
            Logger.Error("Error checking for updates in UI", ex);
        }
        finally
        {
            isChecking = false;
            StateHasChanged();
        }
    }
    
    private async Task OpenReleases()
    {
        try
        {
            var url = updateInfo?.ReleaseUrl ?? "https://github.com/Kita72/UORespawnProject/releases";
            await Launcher.OpenAsync(new Uri(url));
            Logger.Info($"Opened releases page: {url}");
        }
        catch (Exception ex)
        {
            Logger.Error("Error opening releases page", ex);
        }
    }
    
    public void Dispose()
    {
        _autoCheckTimer?.Dispose();
    }
}
